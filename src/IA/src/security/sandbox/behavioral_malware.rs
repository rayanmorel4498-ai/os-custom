use alloc::collections::BTreeMap;
use crate::prelude::{String, Vec, format};

#[derive(Clone, Copy)]
pub struct BehaviorSample {
    pub syscall_rate: f32,
    pub network_bps: u64,
    pub file_writes: u32,
    pub foreground: bool,
}

#[derive(Clone, Copy, PartialEq, Eq)]
pub enum MalwareRisk {
    Low,
    Medium,
    High,
}

pub struct BehavioralMalwareDetector {
    scores: BTreeMap<String, f32>,
    alpha: f32,
}

impl BehavioralMalwareDetector {
    pub fn new() -> Self {
        BehavioralMalwareDetector {
            scores: BTreeMap::new(),
            alpha: 0.2,
        }
    }

    pub fn update(&mut self, app_id: &str, sample: BehaviorSample) -> MalwareRisk {
        let sys = (sample.syscall_rate / 5000.0).clamp(0.0, 1.0);
        let net = (sample.network_bps as f32 / 5_000_000.0).clamp(0.0, 1.0);
        let writes = (sample.file_writes as f32 / 200.0).clamp(0.0, 1.0);
        let mut score = (0.4 * sys) + (0.4 * net) + (0.2 * writes);
        if sample.foreground {
            score *= 0.7;
        }
        let entry = self.scores.entry(app_id.into()).or_insert(score);
        *entry = (self.alpha * score) + ((1.0 - self.alpha) * *entry);

        if *entry > 0.85 {
            MalwareRisk::High
        } else if *entry > 0.65 {
            MalwareRisk::Medium
        } else {
            MalwareRisk::Low
        }
    }

    pub fn top_suspects(&self, limit: usize) -> Vec<(String, f32)> {
        let mut list: Vec<(String, f32)> = self.scores.iter().map(|(k, v)| (k.clone(), *v)).collect();
        list.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(core::cmp::Ordering::Equal));
        list.truncate(limit);
        list
    }

    pub fn export(&self) -> String {
        let mut out = String::new();
        for (app, score) in self.scores.iter() {
            out.push_str(&format!("{}={:.2},", app, score));
        }
        out
    }
}

impl Default for BehavioralMalwareDetector {
    fn default() -> Self {
        Self::new()
    }
}
